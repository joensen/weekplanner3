<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Madplan Admin</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #fff;
      min-height: 100vh;
      padding: 16px;
      padding-top: 50px;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .status-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #252540;
      padding: 8px 16px;
      font-size: 12px;
      color: #888;
      display: flex;
      justify-content: space-between;
      z-index: 100;
    }

    .status-bar .connected { color: #4caf50; }
    .status-bar .disconnected { color: #f44336; }

    h2 {
      font-size: 20px;
      color: #4fc3f7;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #333;
    }

    .section {
      margin-bottom: 32px;
    }

    /* Category cards */
    .category-card {
      background: #252540;
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
    }

    .category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      cursor: pointer;
      user-select: none;
      gap: 8px;
    }

    .category-header:active {
      background: #2d2d50;
    }

    .category-title {
      font-weight: 600;
      font-size: 16px;
      flex: 1;
    }

    .category-count {
      color: #888;
      font-size: 13px;
      margin-right: 8px;
    }

    .category-actions {
      display: flex;
      gap: 8px;
    }

    .category-body {
      display: none;
      padding: 0 16px 16px;
    }

    .category-body.open {
      display: block;
    }

    /* Meal items */
    .meal-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #333;
      min-height: 44px;
    }

    .meal-item:last-of-type {
      border-bottom: none;
    }

    .meal-name {
      flex: 1;
      font-size: 15px;
    }

    .meal-actions {
      display: flex;
      gap: 6px;
    }

    /* Add meal form */
    .add-meal-form {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .add-meal-form input {
      flex: 1;
      min-width: 0;
    }

    /* Buttons */
    .btn {
      background: #333355;
      color: #ccc;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      min-height: 44px;
      min-width: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
    }

    .btn:active {
      background: #444466;
    }

    .btn-primary {
      background: #4fc3f7;
      color: #000;
      font-weight: 500;
    }

    .btn-primary:active {
      background: #3aa8d8;
    }

    .btn-danger {
      background: #553333;
      color: #f88;
    }

    .btn-danger:active {
      background: #664444;
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 13px;
      min-height: 36px;
      min-width: 36px;
    }

    /* Inputs */
    input, select {
      background: #1a1a2e;
      color: #fff;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 12px;
      font-size: 16px;
      min-height: 44px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #4fc3f7;
    }

    /* New category form */
    .new-category-form {
      background: #252540;
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
      display: none;
    }

    .new-category-form.open {
      display: block;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      color: #888;
      margin-bottom: 4px;
    }

    .form-group input {
      width: 100%;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* Weekday mapping */
    .weekday-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      min-height: 44px;
    }

    .weekday-label {
      width: 80px;
      font-size: 15px;
      font-weight: 500;
    }

    .weekday-select {
      flex: 1;
      min-width: 0;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }

    .save-weekdays {
      margin-top: 16px;
      width: 100%;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4fc3f7;
      color: #000;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 1000;
      max-width: 90vw;
      text-align: center;
    }

    .toast.show {
      opacity: 1;
    }

    .toast.error {
      background: #f44336;
      color: #fff;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    /* Back link */
    .back-link {
      color: #4fc3f7;
      text-decoration: none;
      font-size: 14px;
    }

    .back-link:active {
      opacity: 0.7;
    }

    header .subtitle {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="status-bar">
    <span>Madplan Admin</span>
    <span id="connection-status" class="disconnected">Forbinder...</span>
  </div>

  <header>
    <h1>Madplan Admin</h1>
    <div class="subtitle">
      <a href="/meals.html" class="back-link">Tilbage til madplan</a>
    </div>
  </header>

  <main id="admin-container">
    <div class="loading">Indl&aelig;ser...</div>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    const dayNames = ['S\u00f8ndag', 'Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag', 'L\u00f8rdag'];
    // Weekday order for display (Monday first)
    const weekdayOrder = [1, 2, 3, 4, 5, 6, 0];

    const categoryEmojis = {
      'ris': '\u{1F35A}',
      'kartofler': '\u{1F954}',
      'pasta': '\u{1F35D}',
      'mexicansk': '\u{1F32E}',
      'fastfood': '\u{1F35F}',
      'suppe': '\u{1F372}',
      'andet': '\u{1F37D}'
    };

    let adminData = null;
    let eventSource = null;
    let openCategories = new Set();

    // ─── Toast ──────────────────────────────────────────────────

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => toast.className = 'toast', 2500);
    }

    // ─── SSE ────────────────────────────────────────────────────

    function setConnectionStatus(connected) {
      const status = document.getElementById('connection-status');
      if (connected) {
        status.textContent = 'Forbundet';
        status.className = 'connected';
      } else {
        status.textContent = 'Afbrudt';
        status.className = 'disconnected';
      }
    }

    function connectSSE() {
      eventSource = new EventSource('/api/events-stream');
      eventSource.onopen = () => setConnectionStatus(true);
      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'meal-update') {
          loadAdminData();
        }
      };
      eventSource.onerror = () => {
        setConnectionStatus(false);
        eventSource.close();
        setTimeout(connectSSE, 5000);
      };
    }

    // ─── API helpers ────────────────────────────────────────────

    async function api(method, path, body) {
      const opts = {
        method,
        headers: { 'Content-Type': 'application/json' }
      };
      if (body !== undefined) opts.body = JSON.stringify(body);
      const res = await fetch('/api/meals' + path, opts);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Fejl');
      return data;
    }

    async function loadAdminData() {
      try {
        adminData = await api('GET', '/admin');
        render();
      } catch (error) {
        console.error('Error loading admin data:', error);
        document.getElementById('admin-container').innerHTML =
          '<div class="loading">Fejl ved indl\u00e6sning</div>';
      }
    }

    // ─── Render ─────────────────────────────────────────────────

    function render() {
      if (!adminData) return;
      const container = document.getElementById('admin-container');

      let html = '';

      // Categories section
      html += '<div class="section">';
      html += '<h2>Kategorier</h2>';

      for (const [catId, category] of Object.entries(adminData.categories)) {
        const emoji = categoryEmojis[catId] || '\u{1F37D}\u{FE0F}';
        const isOpen = openCategories.has(catId);
        const mealCount = category.meals ? category.meals.length : 0;

        html += `<div class="category-card">`;
        html += `<div class="category-header" onclick="toggleCategory('${catId}')">`;
        html += `<span class="category-title">${emoji} ${escapeHtml(category.name)}</span>`;
        html += `<span class="category-count">${mealCount} retter</span>`;
        html += `<div class="category-actions">`;
        html += `<button class="btn btn-sm" onclick="event.stopPropagation(); renameCategory('${catId}', '${escapeAttr(category.name)}')">Omd\u00f8b</button>`;
        html += `<button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteCategory('${catId}', '${escapeAttr(category.name)}')">Slet</button>`;
        html += `</div></div>`;

        html += `<div class="category-body${isOpen ? ' open' : ''}" id="cat-body-${catId}">`;

        // Meal list
        if (category.meals) {
          for (const meal of category.meals) {
            html += `<div class="meal-item">`;
            html += `<span class="meal-name">${escapeHtml(meal)}</span>`;
            html += `<div class="meal-actions">`;
            html += `<button class="btn btn-sm" onclick="renameMeal('${catId}', '${escapeAttr(meal)}')">Omd\u00f8b</button>`;
            html += `<button class="btn btn-sm btn-danger" onclick="deleteMeal('${catId}', '${escapeAttr(meal)}')">Slet</button>`;
            html += `</div></div>`;
          }
        }

        // Add meal form
        html += `<div class="add-meal-form">`;
        html += `<input type="text" id="new-meal-${catId}" placeholder="Ny ret..." onkeydown="if(event.key==='Enter')addMeal('${catId}')">`;
        html += `<button class="btn btn-primary btn-sm" onclick="addMeal('${catId}')">+</button>`;
        html += `</div>`;

        html += `</div></div>`;
      }

      // New category button + form
      html += `<button class="btn btn-primary" onclick="toggleNewCategoryForm()" id="new-cat-btn">+ Ny kategori</button>`;
      html += `<div class="new-category-form" id="new-category-form">`;
      html += `<div class="form-group"><label>ID (kun sm\u00e5 bogstaver, f.eks. "fisk")</label>`;
      html += `<input type="text" id="new-cat-id" placeholder="f.eks. fisk" pattern="[a-z0-9_-]+"></div>`;
      html += `<div class="form-group"><label>Navn</label>`;
      html += `<input type="text" id="new-cat-name" placeholder="f.eks. Fisk" onkeydown="if(event.key==='Enter')addCategory()"></div>`;
      html += `<div class="form-actions">`;
      html += `<button class="btn" onclick="toggleNewCategoryForm()">Annuller</button>`;
      html += `<button class="btn btn-primary" onclick="addCategory()">Tilf\u00f8j</button>`;
      html += `</div></div>`;

      html += '</div>';

      // Weekday categories section
      html += '<div class="section">';
      html += '<h2>Ugedage</h2>';

      for (const dayIdx of weekdayOrder) {
        const currentCat = adminData.weekdayCategories[dayIdx.toString()] || '';
        html += `<div class="weekday-row">`;
        html += `<span class="weekday-label">${dayNames[dayIdx]}</span>`;
        html += `<select class="weekday-select" data-day="${dayIdx}">`;
        for (const [catId, category] of Object.entries(adminData.categories)) {
          const selected = catId === currentCat ? 'selected' : '';
          html += `<option value="${catId}" ${selected}>${escapeHtml(category.name)}</option>`;
        }
        html += `</select></div>`;
      }

      html += `<button class="btn btn-primary save-weekdays" onclick="saveWeekdays()">Gem \u00e6ndringer</button>`;
      html += '</div>';

      container.innerHTML = html;
    }

    // ─── Helpers ────────────────────────────────────────────────

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function escapeAttr(str) {
      return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    function toggleCategory(catId) {
      if (openCategories.has(catId)) {
        openCategories.delete(catId);
      } else {
        openCategories.add(catId);
      }
      const body = document.getElementById('cat-body-' + catId);
      if (body) body.classList.toggle('open');
    }

    function toggleNewCategoryForm() {
      document.getElementById('new-category-form').classList.toggle('open');
    }

    // ─── Category actions ───────────────────────────────────────

    async function addCategory() {
      const idInput = document.getElementById('new-cat-id');
      const nameInput = document.getElementById('new-cat-name');
      const id = idInput.value.trim().toLowerCase();
      const name = nameInput.value.trim();

      if (!id || !name) {
        showToast('Udfyld b\u00e5de ID og navn', true);
        return;
      }

      try {
        await api('POST', '/categories', { id, name });
        idInput.value = '';
        nameInput.value = '';
        toggleNewCategoryForm();
        showToast('Kategori tilf\u00f8jet');
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    async function renameCategory(id, currentName) {
      const newName = prompt('Nyt navn for kategori:', currentName);
      if (!newName || newName === currentName) return;

      try {
        await api('PUT', '/categories/' + encodeURIComponent(id), { name: newName });
        showToast('Kategori omd\u00f8bt');
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    async function deleteCategory(id, name) {
      if (!confirm('Slet kategorien "' + name + '"?\n\nAlle retter i kategorien slettes ogs\u00e5.')) return;

      try {
        await api('DELETE', '/categories/' + encodeURIComponent(id));
        openCategories.delete(id);
        showToast('Kategori slettet');
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    // ─── Meal actions ───────────────────────────────────────────

    async function addMeal(categoryId) {
      const input = document.getElementById('new-meal-' + categoryId);
      const name = input.value.trim();
      if (!name) return;

      try {
        await api('POST', '/categories/' + encodeURIComponent(categoryId) + '/meals', { name });
        input.value = '';
        showToast('Ret tilf\u00f8jet');
        openCategories.add(categoryId);
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    async function renameMeal(categoryId, oldName) {
      const newName = prompt('Nyt navn for ret:', oldName);
      if (!newName || newName === oldName) return;

      try {
        await api('PUT', '/categories/' + encodeURIComponent(categoryId) + '/meals', { oldName, newName });
        showToast('Ret omd\u00f8bt');
        openCategories.add(categoryId);
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    async function deleteMeal(categoryId, mealName) {
      if (!confirm('Slet retten "' + mealName + '"?')) return;

      try {
        await api('DELETE', '/categories/' + encodeURIComponent(categoryId) + '/meals/' + encodeURIComponent(mealName));
        showToast('Ret slettet');
        openCategories.add(categoryId);
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    // ─── Weekday mapping ────────────────────────────────────────

    async function saveWeekdays() {
      const mapping = {};
      document.querySelectorAll('.weekday-select').forEach(select => {
        mapping[select.dataset.day] = select.value;
      });

      try {
        await api('PUT', '/weekday-categories', mapping);
        showToast('Ugedage gemt');
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    // ─── Init ───────────────────────────────────────────────────

    document.addEventListener('DOMContentLoaded', () => {
      loadAdminData();
      connectSSE();
    });
  </script>
</body>
</html>
