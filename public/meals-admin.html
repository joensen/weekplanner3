<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Madplan Admin</title>
  <link rel="stylesheet" href="/css/meals.css">
  <link rel="stylesheet" href="/css/meals-admin.css">
</head>
<body>
  <div class="status-bar">
    <span>Madplan Admin</span>
    <span id="connection-status" class="disconnected">Forbinder...</span>
  </div>

  <header>
    <h1>Madplan Admin</h1>
    <div class="subtitle">
      <a href="/meals.html" onclick="event.preventDefault();window.location.href='/meals.html'" class="nav-link">Tilbage til madplan</a>
    </div>
  </header>

  <main id="admin-container">
    <div class="loading">Indl&aelig;ser...</div>
  </main>

  <div id="toast" class="toast"></div>

  <script>
    const dayNames = ['S\u00f8ndag', 'Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag', 'L\u00f8rdag'];
    // Weekday order for display (Monday first)
    const weekdayOrder = [1, 2, 3, 4, 5, 6, 0];

    const foodEmojis = [
      '\u{1F35A}', '\u{1F954}', '\u{1F35D}', '\u{1F32E}', '\u{1F35F}', '\u{1F372}', '\u{1F37D}\u{FE0F}',
      '\u{1F355}', '\u{1F969}', '\u{1F41F}', '\u{1F957}', '\u{1F956}', '\u{1F32F}', '\u{1F958}',
      '\u{1F959}', '\u{1F95F}', '\u{1F9C6}', '\u{1F96A}', '\u{1F35B}', '\u{1F35C}',
      '\u{1F95A}', '\u{1F953}', '\u{1F960}', '\u{1F96E}', '\u{1F9C7}', '\u{1F354}'
    ];

    let adminData = null;
    let eventSource = null;
    let openCategories = new Set();

    // ─── Toast ──────────────────────────────────────────────────

    function showToast(message, isError = false) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show' + (isError ? ' error' : '');
      setTimeout(() => toast.className = 'toast', 2500);
    }

    // ─── SSE ────────────────────────────────────────────────────

    function setConnectionStatus(connected) {
      const status = document.getElementById('connection-status');
      if (connected) {
        status.textContent = 'Forbundet';
        status.className = 'connected';
      } else {
        status.textContent = 'Afbrudt';
        status.className = 'disconnected';
      }
    }

    function connectSSE() {
      eventSource = new EventSource('/api/events-stream');
      eventSource.onopen = () => setConnectionStatus(true);
      eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'meal-update') {
          loadAdminData();
        }
      };
      eventSource.onerror = () => {
        setConnectionStatus(false);
        eventSource.close();
        setTimeout(connectSSE, 5000);
      };
    }

    // ─── API helpers ────────────────────────────────────────────

    async function api(method, path, body) {
      const opts = {
        method,
        headers: { 'Content-Type': 'application/json' }
      };
      if (body !== undefined) opts.body = JSON.stringify(body);
      const res = await fetch('/api/meals' + path, opts);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Fejl');
      return data;
    }

    async function loadAdminData() {
      try {
        adminData = await api('GET', '/admin');
        render();
      } catch (error) {
        console.error('Error loading admin data:', error);
        document.getElementById('admin-container').innerHTML =
          '<div class="loading">Fejl ved indl\u00e6sning</div>';
      }
    }

    // ─── Render ─────────────────────────────────────────────────

    function render() {
      if (!adminData) return;
      const container = document.getElementById('admin-container');

      let html = '';

      // Categories section
      html += '<div class="section">';
      html += '<h2>Kategorier</h2>';

      for (const [catId, category] of Object.entries(adminData.categories)) {
        const emoji = category.emoji || '\u{1F37D}\u{FE0F}';
        const isOpen = openCategories.has(catId);
        const mealCount = category.meals ? category.meals.length : 0;

        html += `<div class="category-card">`;
        html += `<div class="category-header" onclick="toggleCategory('${catId}')">`;
        html += `<button class="btn btn-sm emoji-btn" onclick="event.stopPropagation(); changeEmoji('${catId}')" title="Skift emoji">${emoji}</button>`;
        html += `<span class="category-title">${escapeHtml(category.name)}</span>`;
        html += `<span class="category-count">${mealCount} retter</span>`;
        html += `<div class="category-actions">`;
        html += `<button class="btn btn-sm" onclick="event.stopPropagation(); renameCategory('${catId}', '${escapeAttr(category.name)}')">Omd\u00f8b</button>`;
        html += `<button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteCategory('${catId}', '${escapeAttr(category.name)}')">Slet</button>`;
        html += `</div></div>`;

        html += `<div class="category-body${isOpen ? ' open' : ''}" id="cat-body-${catId}">`;

        // Meal list
        if (category.meals) {
          for (const meal of category.meals) {
            html += `<div class="meal-item">`;
            html += `<span class="meal-name">${escapeHtml(meal)}</span>`;
            html += `<div class="meal-actions">`;
            html += `<button class="btn btn-sm" onclick="renameMeal('${catId}', '${escapeAttr(meal)}')">Omd\u00f8b</button>`;
            html += `<button class="btn btn-sm btn-danger" onclick="deleteMeal('${catId}', '${escapeAttr(meal)}')">Slet</button>`;
            html += `</div></div>`;
          }
        }

        // Add meal form
        html += `<div class="add-meal-form">`;
        html += `<input type="text" id="new-meal-${catId}" placeholder="Ny ret..." onkeydown="if(event.key==='Enter')addMeal('${catId}')">`;
        html += `<button class="btn btn-primary btn-sm" onclick="addMeal('${catId}')">+</button>`;
        html += `</div>`;

        html += `</div></div>`;
      }

      // New category button + form
      html += `<button class="btn btn-primary" onclick="toggleNewCategoryForm()" id="new-cat-btn">+ Ny kategori</button>`;
      html += `<div class="new-category-form" id="new-category-form">`;
      html += `<div class="form-group"><label>ID (kun sm\u00e5 bogstaver, f.eks. "fisk")</label>`;
      html += `<input type="text" id="new-cat-id" placeholder="f.eks. fisk" pattern="[a-z0-9_-]+"></div>`;
      html += `<div class="form-group"><label>Navn</label>`;
      html += `<input type="text" id="new-cat-name" placeholder="f.eks. Fisk" onkeydown="if(event.key==='Enter')addCategory()"></div>`;
      html += `<div class="form-group"><label>Emoji</label>`;
      html += `<div class="emoji-grid" id="new-cat-emoji-grid">`;
      for (const e of foodEmojis) {
        html += `<button type="button" class="emoji-option${e === '\u{1F37D}\u{FE0F}' ? ' selected' : ''}" onclick="selectNewCatEmoji(this, '${e}')">${e}</button>`;
      }
      html += `</div></div>`;
      html += `<div class="form-actions">`;
      html += `<button class="btn" onclick="toggleNewCategoryForm()">Annuller</button>`;
      html += `<button class="btn btn-primary" onclick="addCategory()">Tilf\u00f8j</button>`;
      html += `</div></div>`;

      html += '</div>';

      // Weekday categories section
      html += '<div class="section">';
      html += '<h2>Ugedage</h2>';

      for (const dayIdx of weekdayOrder) {
        const currentCat = adminData.weekdayCategories[dayIdx.toString()] || '';
        html += `<div class="weekday-row">`;
        html += `<span class="weekday-label">${dayNames[dayIdx]}</span>`;
        html += `<select class="weekday-select" data-day="${dayIdx}">`;
        for (const [catId, category] of Object.entries(adminData.categories)) {
          const selected = catId === currentCat ? 'selected' : '';
          html += `<option value="${catId}" ${selected}>${escapeHtml(category.name)}</option>`;
        }
        html += `</select></div>`;
      }

      html += `<button class="btn btn-primary save-weekdays" onclick="saveWeekdays()">Gem \u00e6ndringer</button>`;
      html += '</div>';

      container.innerHTML = html;
    }

    // ─── Helpers ────────────────────────────────────────────────

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function escapeAttr(str) {
      return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    function toggleCategory(catId) {
      if (openCategories.has(catId)) {
        openCategories.delete(catId);
      } else {
        openCategories.add(catId);
      }
      const body = document.getElementById('cat-body-' + catId);
      if (body) body.classList.toggle('open');
    }

    function toggleNewCategoryForm() {
      document.getElementById('new-category-form').classList.toggle('open');
    }

    // ─── Category actions ───────────────────────────────────────

    let newCatEmoji = '\u{1F37D}\u{FE0F}';

    function selectNewCatEmoji(btn, emoji) {
      newCatEmoji = emoji;
      document.querySelectorAll('#new-cat-emoji-grid .emoji-option').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    }

    async function addCategory() {
      const idInput = document.getElementById('new-cat-id');
      const nameInput = document.getElementById('new-cat-name');
      const id = idInput.value.trim().toLowerCase();
      const name = nameInput.value.trim();

      if (!id || !name) {
        showToast('Udfyld b\u00e5de ID og navn', true);
        return;
      }

      try {
        await api('POST', '/categories', { id, name, emoji: newCatEmoji });
        idInput.value = '';
        nameInput.value = '';
        newCatEmoji = '\u{1F37D}\u{FE0F}';
        toggleNewCategoryForm();
        showToast('Kategori tilf\u00f8jet');
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    function changeEmoji(catId) {
      const category = adminData.categories[catId];
      const currentEmoji = category.emoji || '\u{1F37D}\u{FE0F}';

      let html = '<div class="emoji-picker-overlay" onclick="if(event.target===this)closeEmojiPicker()">';
      html += '<div class="emoji-picker-panel">';
      html += `<h3>V\u00e6lg emoji for ${escapeHtml(category.name)}</h3>`;
      html += '<div class="emoji-grid">';
      for (const e of foodEmojis) {
        html += `<button type="button" class="emoji-option${e === currentEmoji ? ' selected' : ''}" onclick="pickEmoji('${catId}', '${e}')">${e}</button>`;
      }
      html += '</div></div></div>';

      const div = document.createElement('div');
      div.id = 'emoji-picker';
      div.innerHTML = html;
      document.body.appendChild(div);
    }

    function closeEmojiPicker() {
      const picker = document.getElementById('emoji-picker');
      if (picker) picker.remove();
    }

    async function pickEmoji(catId, emoji) {
      closeEmojiPicker();
      const category = adminData.categories[catId];
      try {
        await api('PUT', '/categories/' + encodeURIComponent(catId), { name: category.name, emoji });
        showToast('Emoji opdateret');
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    async function renameCategory(id, currentName) {
      const newName = prompt('Nyt navn for kategori:', currentName);
      if (!newName || newName === currentName) return;

      try {
        await api('PUT', '/categories/' + encodeURIComponent(id), { name: newName });
        showToast('Kategori omd\u00f8bt');
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    async function deleteCategory(id, name) {
      if (!confirm('Slet kategorien "' + name + '"?\n\nAlle retter i kategorien slettes ogs\u00e5.')) return;

      try {
        await api('DELETE', '/categories/' + encodeURIComponent(id));
        openCategories.delete(id);
        showToast('Kategori slettet');
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    // ─── Meal actions ───────────────────────────────────────────

    async function addMeal(categoryId) {
      const input = document.getElementById('new-meal-' + categoryId);
      const name = input.value.trim();
      if (!name) return;

      try {
        await api('POST', '/categories/' + encodeURIComponent(categoryId) + '/meals', { name });
        input.value = '';
        showToast('Ret tilf\u00f8jet');
        openCategories.add(categoryId);
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    async function renameMeal(categoryId, oldName) {
      const newName = prompt('Nyt navn for ret:', oldName);
      if (!newName || newName === oldName) return;

      try {
        await api('PUT', '/categories/' + encodeURIComponent(categoryId) + '/meals', { oldName, newName });
        showToast('Ret omd\u00f8bt');
        openCategories.add(categoryId);
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    async function deleteMeal(categoryId, mealName) {
      if (!confirm('Slet retten "' + mealName + '"?')) return;

      try {
        await api('DELETE', '/categories/' + encodeURIComponent(categoryId) + '/meals/' + encodeURIComponent(mealName));
        showToast('Ret slettet');
        openCategories.add(categoryId);
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    // ─── Weekday mapping ────────────────────────────────────────

    async function saveWeekdays() {
      const mapping = {};
      document.querySelectorAll('.weekday-select').forEach(select => {
        mapping[select.dataset.day] = select.value;
      });

      try {
        await api('PUT', '/weekday-categories', mapping);
        showToast('Ugedage gemt');
        await loadAdminData();
      } catch (error) {
        showToast(error.message, true);
      }
    }

    // ─── Init ───────────────────────────────────────────────────

    window.addEventListener('pagehide', () => {
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadAdminData();
      connectSSE();
    });
  </script>
</body>
</html>
